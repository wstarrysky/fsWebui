# Claude Code Web UI 安全改造 - 修改记录

## 修改概述

基于 `sugyan/claude-code-webui` 进行安全改造，实现只读分析模式。

---

## 1. 后端安全控制层

### 文件: `backend/handlers/chat.ts`

**修改内容:**
- 添加 `READ_ONLY_TOOLS` 只读工具白名单: `Read`, `Grep`, `Glob`, `LSP`, `Task`
- 添加 `BLOCKED_WRITE_TOOLS` 写入工具黑名单: `Write`, `Edit`, `Delete`, `Move`, `Bash`
- 实现 `getAllowedTools()` 函数，合并白名单与用户工具，过滤写入操作
- 实现 `prepareMessageWithRules()` 函数，新会话自动注入 RULES.md 规则

---

## 2. RULES.md 热加载

### 新增文件: `backend/rules/loader.ts`

**功能:**
- `loadRules()` - 从项目根目录加载 RULES.md
- `getCachedRules()` - 获取缓存的规则内容
- `reloadRules()` - 重新加载规则（热更新）

### 新增文件: `backend/handlers/rules.ts`

**API端点:**
- `GET /api/rules` - 获取当前规则内容
- `POST /api/rules/reload` - 重新加载规则文件

### 修改文件: `backend/app.ts`

- 注册规则相关路由
- 应用启动时自动加载 RULES.md

---

## 3. 前端 UI 简化

### 文件: `frontend/src/components/chat/ChatMessages.tsx`

**修改内容:**
- 简化 `renderMessage()` 函数，只渲染 `chat` 类型消息
- 隐藏消息类型: `system`, `tool`, `tool_result`, `thinking`, `todo`, `plan`
- 移除未使用的组件导入

### 文件: `frontend/src/components/ChatPage.tsx`

**修改内容:**
- 标题从 "Claude Code Web UI" 改为 "问题解答小助手"
- 标题从 `<button>` 改为 `<h1>`，移除点击事件
- 移除 `handleBackToProjects` 和 `handleBackToProjectChat` 函数
- 隐藏工作目录绝对路径显示

---

## 4. 安全配置文件

### 新增文件: `frontend/src/config/safety.ts`

```typescript
export const ALLOWED_MESSAGE_TYPES = new Set(["user", "assistant"]);
export const BLOCKED_MESSAGE_TYPES = new Set([
  "system", "tool", "tool_result", "thinking", "todo", "plan"
]);
export const CODE_BLOCK_CONFIG = { FOLD_THRESHOLD: 10 };
```

---

## 5. 代码块折叠

### 新增文件: `frontend/src/components/CodeBlockRenderer.tsx`

**功能:**
- 解析 Markdown 代码块
- 超过 10 行自动折叠
- 提供展开/收起按钮
- 显示代码行数

---

## 6. 流式解析修复

### 文件: `frontend/src/hooks/streaming/useStreamParser.ts`

**修改内容:**
- 移除错误的 SDK 级别消息过滤（之前阻断了 session_id 传递）
- 保留所有 SDK 消息类型的处理，过滤在渲染层进行

---

## 文件变更清单

| 文件路径 | 操作 |
|----------|------|
| `backend/handlers/chat.ts` | 修改 |
| `backend/handlers/rules.ts` | 新增 |
| `backend/rules/loader.ts` | 新增 |
| `backend/app.ts` | 修改 |
| `frontend/src/components/chat/ChatMessages.tsx` | 修改 |
| `frontend/src/components/ChatPage.tsx` | 修改 |
| `frontend/src/components/CodeBlockRenderer.tsx` | 新增 |
| `frontend/src/config/safety.ts` | 新增 |
| `frontend/src/hooks/streaming/useStreamParser.ts` | 修改 |
| `RULES.md` | 新增 |

---

## 版本信息

- 基础版本: sugyan/claude-code-webui
- 改造日期: 2026-01-08
- 改造目标: 只读安全模式 MVP
