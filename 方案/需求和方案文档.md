# Claude Code Web UI 安全改造方案

## 项目概述

基于 [sugyan/claude-code-webui](https://github.com/sugyan/claude-code-webui) 进行安全改造，
打造一个**只读分析型** Claude Code Web 界面，用于代码分析和展示，禁止所有写入操作。

---

## 需求列表

### 1. 保持Web交互方式
- ✅ 保留现有的流式聊天体验
- ✅ 保留用户消息和Claude回复的展示

### 2. 安全原则（第一优先级）
只提供分析以及展示，**所有需要写入权限的操作全部拒绝**：

| 操作类型 | 允许/拒绝 | 说明 |
|---------|----------|------|
| 文件读取 (Read) | ✅ 允许 | 读取代码文件内容 |
| 代码搜索 (Grep) | ✅ 允许 | 搜索代码内容 |
| 文件查找 (Glob) | ✅ 允许 | 查找文件路径 |
| LSP查询 | ✅ 允许 | 代码定义、引用查询 |
| Bash执行 | ❌ 拒绝 | 包括 git push, npm install 等 |
| 文件写入 (Write) | ❌ 拒绝 | 创建新文件 |
| 文件编辑 (Edit) | ❌ 拒绝 | 修改现有文件 |
| 文件删除/移动 | ❌ 拒绝 | 删除或移动文件 |
| MCP写入操作 | ❌ 拒绝 | MCP服务的写入类操作 |
| 其他写入类工具 | ❌ 拒绝 | 待补充场景 |

### 3. RULES.md 热加载
- ✅ 规则文件放于项目根目录 `RULES.md`
- ✅ 规则只发送给LLM，**不向用户展示**
- ✅ 提供API端点用于重新加载规则（无需重启服务）
- ✅ 每次对话开始时自动注入规则内容

### 4. 简化页面展示

| UI元素 | 保留/隐藏 | 说明 |
|--------|----------|------|
| 消息正文 | ✅ 保留 | Claude的回复内容（流式） |
| 用户消息 | ✅ 保留 | 用户发送的问题 |
| 时间戳 | ❌ 隐藏 | 每条消息的时间 |
| 工具调用日志 | ❌ 隐藏 | 🔧 Bash、Read等工具调用记录 |
| 工具结果 | ❌ 隐藏 | ✓ 工具执行结果（代码预览等） |
| 系统消息 | ❌ 隐藏 | ⚙️ 初始化、错误等系统提示 |
| 思考过程 | ❌ 隐藏 | 💭 Claude的推理过程 |
| 待办事项 | ❌ 隐藏 | 📋 TodoList更新 |
| 计划消息 | ❌ 隐藏 | 📋 Plan模式内容 |
| 加载动画 | ✅ 保留 | "Thinking..." 旋转图标 |
| 权限弹窗 | ❌ 移除 | 写入类工具直接拒绝，无需弹窗 |

---

## 技术方案

### 2.1 安全控制层

#### 方案选择：后端拦截 + 前端配合

**实现位置**：`backend/handlers/chat.ts`

```typescript
// 只读工具白名单
const READ_ONLY_TOOLS = new Set([
  'Read',
  'Grep',
  'Glob',
  'LSP',
]);

// 工具请求拦截器
function interceptToolRequest(tool: ToolRequest): ToolRequest | null {
  const toolName = tool.name;

  // 允许只读工具
  if (READ_ONLY_TOOLS.has(toolName)) {
    return tool;
  }

  // 拒绝所有写入类工具
  return {
    ...tool,
    error: 'Tool blocked: Write operations are not allowed in safe mode'
  };
}
```

#### Claude CLI 集成点

在调用 Claude CLI 时，通过 `allowedTools` 参数限制：
```bash
claude --output-format stream-json --allowed-tools Read,Grep,Glob,LSP
```

### 2.2 RULES.md 热加载

#### 文件结构
```
backend/
├── rules/
│   ├── loader.ts       # 规则加载器
│   └── RULES.md        # 规则文件（软链接到根目录）
RULES.md                # 用户可编辑的规则文件
```

#### API 端点
```
GET  /api/rules          # 获取当前规则
POST /api/rules/reload   # 重新加载规则文件
```

#### 规则注入方式

在每次会话开始时，将规则作为系统消息前置：

```typescript
const systemPrompt = `
${await getRulesContent()}

You are operating in SAFE READ-ONLY mode.
Only the following tools are available: ${ALLOWED_TOOLS.join(', ')}
All write operations will be automatically blocked.
`;
```

### 2.3 前端UI简化

#### 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `frontend/src/components/MessageComponents.tsx` | 移除不需要的消息组件渲染 |
| `frontend/src/hooks/useStreaming.ts` | 过滤不需要的消息类型 |
| `frontend/src/config/api.ts` | 添加安全模式配置 |

#### 消息过滤逻辑

```typescript
// 只保留的消息类型
const ALLOWED_MESSAGE_TYPES = new Set([
  'user',           // 用户消息
  'assistant',      // Claude回复
]);

// 过滤掉的消息类型
const BLOCKED_MESSAGE_TYPES = new Set([
  'tool',           // 工具调用
  'tool_result',    // 工具结果
  'system',         // 系统消息
  'thinking',       // 思考过程
  'todo',           // 待办事项
  'plan',           // 计划消息
]);
```

---

## 实施步骤

### Phase 1: 安全控制（优先级最高）
1. [ ] 创建只读工具白名单配置
2. [ ] 实现后端工具拦截器
3. [ ] 修改 Claude CLI 调用参数
4. [ ] 移除前端权限弹窗组件

### Phase 2: 规则热加载
1. [ ] 创建 RULES.md 文件
2. [ ] 实现规则加载器模块
3. [ ] 添加规则管理API端点
4. [ ] 实现规则注入逻辑

### Phase 3: UI简化
1. [ ] 修改消息过滤逻辑
2. [ ] 移除不需要的组件渲染
3. [ ] 保留加载动画和流式输出

### Phase 4: 测试验证
1. [ ] 验证写入操作被正确拒绝
2. [ ] 验证只读操作正常工作
3. [ ] 验证规则热加载功能
4. [ ] 验证UI展示符合预期

---

## 文件变更预估

### 后端 (backend/)
```
handlers/chat.ts          # 添加工具拦截逻辑
middleware/safety.ts      # 新增：安全中间件
rules/loader.ts           # 新增：规则加载器
rules/RULES.md            # 新增：规则文件
cli/args.ts               # 添加 allowedTools 参数
```

### 前端 (frontend/)
```
src/components/MessageComponents.tsx   # 简化消息组件
src/hooks/useStreaming.ts              # 添加消息过滤
src/config/safety.ts                   # 新增：安全配置
src/chat/PermissionInputPanel.tsx      # 移除或简化
```

### 根目录
```
RULES.md                               # 用户规则文件
```

---

## 配置示例

### RULES.md 示例
```markdown
# Claude 安全分析规则

你是一个代码分析助手，运行在**只读安全模式**下。

## 可用能力
- 读取代码文件
- 搜索代码内容
- 查找文件路径
- 代码定义跳转

## 禁止操作
- 任何形式的文件写入
- 执行系统命令
- 修改代码

## 回答风格
- 简洁直接
- 重点突出
- 代码分析优先
```

---

## 风险与限制

1. **Claude 行为不可预测**：即使限制工具，Claude 仍可能尝试使用被禁用的工具
2. **功能完整性**：某些 Claude 能力将无法使用（如执行代码、安装依赖）
3. **用户体验**：拒绝操作时可能需要清晰的错误提示

---

## 后续扩展

- [ ] 添加配置文件，支持自定义白名单
- [ ] 添加审计日志，记录拒绝的操作
- [ ] 添加简单的认证机制
- [ ] 支持多个规则文件切换

---

## 阶梯开发计划（敏捷MVP优先）

### 阶梯 1：MVP（当前实施目标）
**目标**：最小可行性产品，快速验证核心功能

| 功能 | 实现方式 |
|------|----------|
| 只读工具白名单 | 后端 `allowedTools` 参数 |
| 代码块折叠 | 前端检测超过阈值的代码块 |
| RULES.md 热加载 | 后端规则加载器 + API端点 |
| UI简化 | 前端消息过滤 |
| 访问方式 | 局域网任意访问（无认证） |

### 阶梯 2：安全增强（未来迭代）
| 功能 | 说明 |
|------|------|
| 用户认证 | 简单的密码/Token认证 |
| 会话隔离 | 不同用户的对话互不可见 |
| 敏感词脱敏 | 密钥、IP等敏感信息替换 |
| 访问日志 | 记录所有操作请求 |

### 阶梯 3：高级功能（长期规划）
| 功能 | 说明 |
|------|------|
| 提问频率限制 | 防止过度请求 |
| 代码读取量限制 | 单次会话读取行数上限 |
| 敏感目录黑名单 | 禁止访问某些目录 |
| RBAC权限 | 不同角色不同权限 |

---

## 代码块折叠方案

### 检测逻辑（前端）
```typescript
// 检测markdown代码块：```language
const CODE_BLOCK_PATTERN = /```(\w+)?\n([\s\S]+?)```/g;

// 阈值配置
const CODE_BLOCK_THRESHOLD = 10; // 超过10行自动折叠
```

### 用户交互
```
未折叠（≤10行）：
┌─────────────────────┐
│ function add(a, b) { │
│   return a + b;     │
│ }                   │
└─────────────────────┘

已折叠（>10行）：
┌─────────────────────────────────────┐
│ [代码块已折叠 - 共25行，点击展开]   │
└─────────────────────────────────────┘
```
